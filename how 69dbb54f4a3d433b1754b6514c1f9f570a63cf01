[33mcommit 69dbb54f4a3d433b1754b6514c1f9f570a63cf01[m
Author: kuailefengnan2024 <han552401231@gmail.com>
Date:   Fri Oct 17 21:23:28 2025 +0800

    save

[1mdiff --git a/.cursorignore b/.cursorignore[m
[1mnew file mode 100644[m
[1mindex 0000000..b021d93[m
[1m--- /dev/null[m
[1m+++ b/.cursorignore[m
[36m@@ -0,0 +1,5 @@[m
[32m+[m[32m# å¦‚æžœä¹‹å‰æœ‰å¿½ç•¥æ‰€æœ‰ .env æ–‡ä»¶[m
[32m+[m[32m*.env[m
[32m+[m
[32m+[m[32m# ä½†ä¸å¿½ç•¥æ ¹ç›®å½•çš„ .env æ–‡ä»¶[m
[32m+[m[32m!/.env[m
\ No newline at end of file[m
[1mdiff --git a/README.md b/README.md[m
[1mindex 7e4a8d0..a1a37e3 100644[m
[1m--- a/README.md[m
[1m+++ b/README.md[m
[36m@@ -58,8 +58,10 @@[m [mAestheticModel/[m
 â”œâ”€â”€ data_engine/               # è´Ÿè´£æ•°æ®ç”Ÿäº§çš„ç‹¬ç«‹æ¨¡å— (å¯¹åº”Phase 1)[m
 â”‚   â”œâ”€â”€ __init__.py            # -> ä½¿data_engineæˆä¸ºä¸€ä¸ªå¯å¯¼å…¥çš„PythonåŒ…[m
 â”‚   â”œâ”€â”€ generate_data.py       # -> è‡ªåŠ¨åŒ–ç”Ÿæˆæˆå¯¹åå¥½æ•°æ®çš„æ ¸å¿ƒè„šæœ¬ (å¯¹åº”TODO 1.2)[m
[31m-â”‚   â””â”€â”€ prompts/               # -> å­˜æ”¾ç”¨äºŽå¼•å¯¼VLMçš„Promptæ¨¡æ¿[m
[31m-â”‚       â””â”€â”€ judge_prompt.txt   # -> "è£åˆ¤Prompt"ï¼Œå¼•å¯¼VLMè¾“å‡ºç»“æž„åŒ–è¯„åˆ† (å¯¹åº”TODO 1.1)[m
[32m+[m[32mâ”‚   â”œâ”€â”€ generate_prompts.py    # -> (æ–°) ä½¿ç”¨LLMæ‰¹é‡ç”Ÿæˆå›¾ç‰‡æè¿°æç¤ºè¯çš„è„šæœ¬[m
[32m+[m[32mâ”‚   â””â”€â”€ prompts/               # -> å­˜æ”¾ç”¨äºŽå¼•å¯¼AIçš„Promptæ¨¡æ¿[m
[32m+[m[32mâ”‚       â”œâ”€â”€ judge_prompt.txt   # -> "è£åˆ¤Prompt"ï¼Œå¼•å¯¼VLMè¾“å‡ºç»“æž„åŒ–è¯„åˆ† (å¯¹åº”TODO 1.1)[m
[32m+[m[32mâ”‚       â””â”€â”€ image_prompt_generator.txt # -> (æ–°) "å…ƒæç¤ºè¯"ï¼Œç”¨äºŽå¼•å¯¼LLMç”Ÿæˆå›¾ç‰‡æç¤ºè¯[m
 â”‚[m
 â”œâ”€â”€ scripts/                   # å­˜æ”¾æ¨¡åž‹è®­ç»ƒä¸Žè¯„ä¼°ç›¸å…³çš„å¯æ‰§è¡Œè„šæœ¬ (å¯¹åº”Phase 3)[m
 â”‚   â”œâ”€â”€ train.py               # -> å¯åŠ¨æ¨¡åž‹è®­ç»ƒçš„å…¥å£è„šæœ¬ (å¯¹åº”TODO 3.1 & 3.3)[m
[36m@@ -68,4 +70,18 @@[m [mAestheticModel/[m
 â”œâ”€â”€ .gitignore                 # -> Gitå¿½ç•¥æ–‡ä»¶é…ç½®[m
 â”œâ”€â”€ README.md                  # -> æœ¬æ–‡æ¡£[m
 â””â”€â”€ requirements.txt           # -> é¡¹ç›®æ‰€éœ€çš„Pythonä¾èµ–åº“[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m### **5. APIæœåŠ¡ç»“æž„è¯´æ˜Ž (API Service Structure)**[m
[32m+[m
[32m+[m
[32m+[m[32m```[m
[32m+[m[32mapi/[m
[32m+[m[32mâ”œâ”€â”€ vision/                    # -> å­˜æ”¾ä¸Žæ ¸å¿ƒè§†è§‰ç†è§£ç›¸å…³çš„APIè·¯ç”±å’Œé€»è¾‘[m
[32m+[m[32mâ”œâ”€â”€ llm/                       # -> å­˜æ”¾ä¸Žå¤§åž‹è¯­è¨€æ¨¡åž‹äº¤äº’ç›¸å…³çš„APIè·¯ç”±å’Œé€»è¾‘[m
[32m+[m[32mâ”œâ”€â”€ image/                     # -> å¯èƒ½ç”¨äºŽå¤„ç†å›¾ç‰‡ç”Ÿæˆã€èŽ·å–ç­‰ä»»åŠ¡çš„API[m
[32m+[m[32mâ”œâ”€â”€ edit/                      # -> å¯èƒ½ç”¨äºŽå¤„ç†å›¾ç‰‡ç¼–è¾‘ã€ä¿®æ”¹ç­‰ä»»åŠ¡çš„API[m
[32m+[m[32mâ”œâ”€â”€ audit/                     # -> å­˜æ”¾ç”¨äºŽå†…å®¹å®¡æ ¸ã€å®‰å…¨è¿‡æ»¤ç›¸å…³çš„APIå’Œé€»è¾‘[m
[32m+[m[32mâ”œâ”€â”€ base.py                    # -> å®šä¹‰APIæœåŠ¡å…±äº«çš„åŸºç±»ã€æ•°æ®æ¨¡åž‹(Pydantic)æˆ–é€šç”¨å·¥å…·å‡½æ•°[m
[32m+[m[32mâ””â”€â”€ factory.py                 # -> åº”ç”¨å·¥åŽ‚ï¼Œè´Ÿè´£åˆ›å»ºå’Œé…ç½®Webåº”ç”¨å®žä¾‹(å¦‚FastAPI)ï¼Œç»„è£…è·¯ç”±å’Œä¸­é—´ä»¶[m
 ```[m
\ No newline at end of file[m
[1mdiff --git a/api/base.py b/api/base.py[m
[1mnew file mode 100644[m
[1mindex 0000000..76cd70f[m
[1m--- /dev/null[m
[1m+++ b/api/base.py[m
[36m@@ -0,0 +1,126 @@[m
[32m+[m[32m"""[m
[32m+[m[32mAPIæŠ½è±¡åŸºç±»å®šä¹‰æ¨¡å—[m
[32m+[m
[32m+[m[32måŠŸèƒ½ï¼šå®šä¹‰ç»Ÿä¸€çš„APIæŽ¥å£è§„èŒƒï¼Œå®žçŽ°é€‚é…å™¨æ¨¡å¼çš„æ ¸å¿ƒæŠ½è±¡å±‚[m
[32m+[m[32mè§’è‰²ï¼šä¸ºä¸åŒåŽ‚å•†çš„APIæä¾›ç»Ÿä¸€çš„æŽ¥å£æ ‡å‡†ï¼Œç¡®ä¿ä¸šåŠ¡å±‚ä»£ç ä¸Žå…·ä½“APIå®žçŽ°è§£è€¦[m
[32m+[m[32mæž¶æž„ï¼šéµå¾ªä¾èµ–å€’ç½®åŽŸåˆ™ï¼Œä¸šåŠ¡é€»è¾‘ä¾èµ–æŠ½è±¡è€Œéžå…·ä½“å®žçŽ°[m
[32m+[m
[32m+[m[32måŒ…å«ä¸‰ç§æ ¸å¿ƒAPIæŠ½è±¡ï¼š[m
[32m+[m[32m- BaseLlmProvider: å¤§è¯­è¨€æ¨¡åž‹æ–‡æœ¬ç”ŸæˆæŽ¥å£[m
[32m+[m[32m- BaseImageProvider: AIå›¾ç‰‡ç”ŸæˆæŽ¥å£[m
[32m+[m[32m- BaseAuditProvider: å†…å®¹å®¡æ ¸æŽ¥å£[m
[32m+[m[32m"""[m
[32m+[m
[32m+[m[32mfrom abc import ABC, abstractmethod[m
[32m+[m[32mfrom typing import Dict, Any, Tuple[m
[32m+[m
[32m+[m[32mfrom config import settings[m
[32m+[m
[32m+[m
[32m+[m[32mclass BaseLlmProvider(ABC):[m
[32m+[m[32m    """[m
[32m+[m[32m    LLM APIæä¾›å•†çš„æŠ½è±¡åŸºç±»ã€‚[m
[32m+[m[32m    æ‰€æœ‰å…·ä½“çš„LLMæä¾›å•†éƒ½åº”ä»Žæ­¤ç±»ç»§æ‰¿ã€‚[m
[32m+[m[32m    """[m
[32m+[m[32m    def __init__(self):[m
[32m+[m[32m        """[m
[32m+[m[32m        åˆå§‹åŒ–åŸºç¡€å±žæ€§ï¼Œä¾‹å¦‚ä»Žå…¨å±€é…ç½®ä¸­è¯»å–é‡è¯•æ¬¡æ•°å’Œå»¶è¿Ÿã€‚[m
[32m+[m[32m        """[m
[32m+[m[32m        self.max_retries = settings.MAX_RETRIES[m
[32m+[m[32m        self.retry_delay = settings.RETRY_DELAY[m
[32m+[m
[32m+[m[32m    @abstractmethod[m
[32m+[m[32m    async def call_api(self, messages: list, **kwargs) -> Tuple[str | None, str | None]:[m
[32m+[m[32m        """[m
[32m+[m[32m        è°ƒç”¨LLM APIå¹¶è¿”å›žæ–‡æœ¬å“åº”ã€‚[m
[32m+[m[41m        [m
[32m+[m[32m        Args:[m
[32m+[m[32m            messages (list): ä¸€ä¸ªéµå¾ªOpenAIæ ¼å¼çš„æ¶ˆæ¯åˆ—è¡¨ï¼Œä¾‹å¦‚:[m
[32m+[m[32m                             [{"role": "system", "content": "You are a helpful assistant."},[m
[32m+[m[32m                              {"role": "user", "content": "Hello!"}][m
[32m+[m[32m            **kwargs: ä¼ é€’ç»™APIå®¢æˆ·ç«¯çš„å…¶ä»–å‚æ•°ã€‚[m
[32m+[m[41m        [m
[32m+[m[32m        Returns:[m
[32m+[m[32m            ä¸€ä¸ªå…ƒç»„ (response_text, error_message)ã€‚[m
[32m+[m[32m        """[m
[32m+[m[32m        pass[m
[32m+[m
[32m+[m[32m    async def close(self):[m
[32m+[m[32m        """å¯é€‰çš„å…³é—­æˆ–æ¸…ç†èµ„æºçš„æ–¹æ³•ã€‚"""[m
[32m+[m[32m        pass[m
[32m+[m
[32m+[m
[32m+[m[32mclass BaseImageProvider(ABC):[m
[32m+[m[32m    """[m
[32m+[m[32m    å›¾ç‰‡ç”Ÿæˆæä¾›å•†çš„æŠ½è±¡åŸºç±»ã€‚[m
[32m+[m[32m    """[m
[32m+[m[32m    @abstractmethod[m
[32m+[m[32m    async def call_api(self, prompt: str, **kwargs) -> Tuple[bytes | None, str | None]:[m
[32m+[m[32m        """[m
[32m+[m[32m        ç”Ÿæˆå•å¼ å›¾ç‰‡ã€‚[m
[32m+[m
[32m+[m[32m        Args:[m
[32m+[m[32m            prompt (str): ç”¨äºŽç”Ÿæˆå›¾ç‰‡çš„æç¤ºè¯ã€‚[m
[32m+[m[32m            **kwargs: å…¶ä»–å¯é€‰å‚æ•°ï¼ˆå¦‚sizeã€qualityç­‰ï¼‰[m
[32m+[m
[32m+[m[32m        Returns:[m
[32m+[m[32m            ä¸€ä¸ªå…ƒç»„ (image_bytes, error_message)ã€‚[m
[32m+[m[32m            - æˆåŠŸæ—¶, image_bytes æ˜¯å›¾ç‰‡çš„åŽŸå§‹å­—èŠ‚æ•°æ®, error_message ä¸º Noneã€‚[m
[32m+[m[32m            - å¤±è´¥æ—¶, image_bytes ä¸º None, error_message åŒ…å«é”™è¯¯æè¿°ã€‚[m
[32m+[m[32m        """[m
[32m+[m[32m        raise NotImplementedError[m
[32m+[m
[32m+[m[32m    async def close(self):[m
[32m+[m[32m        """å¯é€‰çš„å…³é—­æˆ–æ¸…ç†èµ„æºçš„æ–¹æ³•ã€‚"""[m
[32m+[m[32m        pass[m
[32m+[m
[32m+[m
[32m+[m[32mclass BaseAuditProvider(ABC):[m
[32m+[m[32m    """[m
[32m+[m[32m    å†…å®¹å®¡æ ¸ä¸Žè§†è§‰ç†è§£æä¾›å•†çš„æŠ½è±¡åŸºç±»ã€‚[m
[32m+[m[32m    """[m
[32m+[m[32m    @abstractmethod[m
[32m+[m[32m    async def call_api(self, prompt_text: str, **kwargs) -> Tuple[str | None, str | None]:[m
[32m+[m[32m        """[m
[32m+[m[32m        è°ƒç”¨è§†è§‰APIçš„æ ¸å¿ƒæ–¹æ³•ã€‚[m
[32m+[m
[32m+[m[32m        Args:[m
[32m+[m[32m            prompt_text (str): å‘é€ç»™æ¨¡åž‹çš„ç”¨æˆ·æ–‡æœ¬æç¤ºã€‚[m
[32m+[m[32m            **kwargs: å…¶ä»–å¯é€‰çš„ã€ç‰¹å®šäºŽå®žçŽ°çš„å‚æ•° (å¦‚ predefined_messages)ã€‚[m
[32m+[m
[32m+[m[32m        Returns:[m
[32m+[m[32m            ä¸€ä¸ªå…ƒç»„ (content, error_message)ã€‚[m
[32m+[m[32m            - æˆåŠŸæ—¶, content æ˜¯APIè¿”å›žçš„æ–‡æœ¬å†…å®¹, error_message ä¸º Noneã€‚[m
[32m+[m[32m            - å¤±è´¥æ—¶, content ä¸º None, error_message åŒ…å«é”™è¯¯æè¿°ã€‚[m
[32m+[m[32m        """[m
[32m+[m[32m        raise NotImplementedError[m
[32m+[m
[32m+[m[32m    async def close(self):[m
[32m+[m[32m        """å¯é€‰çš„å…³é—­æˆ–æ¸…ç†èµ„æºçš„æ–¹æ³•ã€‚"""[m
[32m+[m[32m        pass[m
[32m+[m
[32m+[m
[32m+[m[32mclass BaseImageEditorProvider(ABC):[m
[32m+[m[32m    """[m
[32m+[m[32m    å›¾ç‰‡ç¼–è¾‘æä¾›å•†çš„æŠ½è±¡åŸºç±»ã€‚[m
[32m+[m[32m    """[m
[32m+[m[32m    @abstractmethod[m
[32m+[m[32m    async def call_api(self, prompt: str, input_image_bytes: bytes, **kwargs) -> Tuple[bytes | None, str | None]:[m
[32m+[m[32m        """[m
[32m+[m[32m        æ ¹æ®æ–‡æœ¬æŒ‡ä»¤ç¼–è¾‘å•å¼ å›¾ç‰‡ã€‚[m
[32m+[m
[32m+[m[32m        Args:[m
[32m+[m[32m            prompt (str): ç”¨äºŽç¼–è¾‘å›¾ç‰‡çš„æ–‡æœ¬æŒ‡ä»¤ã€‚[m
[32m+[m[32m            input_image_bytes (bytes): éœ€è¦è¢«ç¼–è¾‘çš„åŽŸå§‹å›¾ç‰‡çš„å­—èŠ‚æ•°æ®ã€‚[m
[32m+[m[32m            **kwargs: å…¶ä»–å¯é€‰å‚æ•°[m
[32m+[m
[32m+[m[32m        Returns:[m
[32m+[m[32m            ä¸€ä¸ªå…ƒç»„ (output_image_bytes, error_message)ã€‚[m
[32m+[m[32m            - æˆåŠŸæ—¶, output_image_bytes æ˜¯ç¼–è¾‘åŽå›¾ç‰‡çš„å­—èŠ‚æ•°æ®, error_message ä¸º Noneã€‚[m
[32m+[m[32m            - å¤±è´¥æ—¶, output_image_bytes ä¸º None, error_message åŒ…å«é”™è¯¯æè¿°ã€‚[m
[32m+[m[32m        """[m
[32m+[m[32m        raise NotImplementedError[m
[32m+[m
[32m+[m[32m    async def close(self):[m
[32m+[m[32m        """å¯é€‰çš„å…³é—­æˆ–æ¸…ç†èµ„æºçš„æ–¹æ³•ã€‚"""[m
[32m+[m[32m        pass[m
\ No newline at end of file[m
[1mdiff --git a/api/edit/gpt_image_1.py b/api/edit/gpt_image_1.py[m
[1mnew file mode 100644[m
[1mindex 0000000..17a1eac[m
[1m--- /dev/null[m
[1m+++ b/api/edit/gpt_image_1.py[m
[36m@@ -0,0 +1,84 @@[m
[32m+[m[32mimport base64[m
[32m+[m[32mimport uuid[m
[32m+[m[32mimport json[m
[32m+[m[32mfrom typing import Tuple[m
[32m+[m
[32m+[m[32mimport httpx[m
[32m+[m[32mfrom api.base import BaseImageEditorProvider[m
[32m+[m[32mfrom config import settings[m
[32m+[m[32mfrom utils.logger import logger[m
[32m+[m
[32m+[m[32mclass GptImage1EditorProvider(BaseImageEditorProvider):[m
[32m+[m[32m    """[m
[32m+[m[32m    ä¸€ä¸ªé€‚é…å™¨ï¼Œç”¨äºŽè°ƒç”¨ gpt-image-1 æ¨¡åž‹æ¥ç¼–è¾‘å›¾ç‰‡ã€‚[m
[32m+[m[32m    """[m
[32m+[m[32m    def __init__(self, api_key: str, base_url: str, model: str, **kwargs):[m
[32m+[m[32m        if not api_key:[m
[32m+[m[32m            raise ValueError("API key for gpt-image-1 is required.")[m
[32m+[m[41m        [m
[32m+[m[32m        self.model = model[m
[32m+[m[32m        self.api_key = api_key[m
[32m+[m[32m        self.base_url = base_url[m
[32m+[m[32m        self.client = httpx.AsyncClient()[m
[32m+[m[32m        self.output_dir = settings.GENERATED_IMAGES_DIR[m
[32m+[m[32m        self.output_dir.mkdir(parents=True, exist_ok=True)[m
[32m+[m[32m        logger.info(f"GptImage1EditorProvider (httpx) initialized for model: {self.model}")[m
[32m+[m
[32m+[m[32m    async def call_api(self, prompt: str, input_image_bytes: bytes, **kwargs) -> Tuple[bytes | None, str | None]:[m
[32m+[m[32m        """[m
[32m+[m[32m        ä½¿ç”¨ httpx ä»¥ multipart/form-data æ ¼å¼è°ƒç”¨ API ç¼–è¾‘å›¾ç‰‡ï¼Œå¹¶è¿”å›žå­—èŠ‚æµã€‚[m
[32m+[m[32m        """[m
[32m+[m[32m        logger.info(f"Editing image with gpt-image-1 (multipart) for prompt: {prompt[:50]}...")[m
[32m+[m[41m        [m
[32m+[m[32m        # 1. æž„é€ æ­£ç¡®çš„å›¾ç‰‡ç¼–è¾‘ä¸“ç”¨URL[m
[32m+[m[32m        # è¿™æ˜¯è§£å†³é—®é¢˜çš„å…³é”®ï¼šç¼–è¾‘åŠŸèƒ½éœ€è¦ä¸€ä¸ªç‰¹å®šçš„URLè·¯å¾„[m
[32m+[m[32m        request_url = f"{self.base_url.rstrip('/')}/openai/images/edits?ak={self.api_key}"[m
[32m+[m[41m        [m
[32m+[m[32m        # 2. å‡†å¤‡ multipart/form-data[m
[32m+[m[32m        # ä¿®æ­£ï¼šå°†æ‰€æœ‰å‚æ•°éƒ½æ”¾å…¥ files ä¸­ï¼Œä»¥æ›´ç²¾ç¡®åœ°æ¨¡æ‹Ÿè¡¨å•æäº¤[m
[32m+[m[32m        # è¿™å¯ä»¥è§£å†³æŸäº›æŒ‘å‰”çš„APIåŽç«¯æ— æ³•æ­£ç¡®è§£æžæ··åˆ data å’Œ files çš„é—®é¢˜[m
[32m+[m[32m        files = {[m
[32m+[m[32m            'prompt': (None, prompt),[m
[32m+[m[32m            'model': (None, self.model),[m
[32m+[m[32m            'response_format': (None, 'b64_json'),[m
[32m+[m[32m            'n': (None, str(kwargs.get("n", 1))),[m
[32m+[m[32m            'size': (None, kwargs.get("size", "1024x1024")),[m
[32m+[m[32m            'image[]': ("input_image.png", input_image_bytes, "image/png"),[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        try:[m
[32m+[m[32m            # 3. å‘é€ multipart/form-data è¯·æ±‚[m
[32m+[m[32m            response = await self.client.post(request_url, files=files, timeout=180)[m
[32m+[m[32m            response.raise_for_status()[m
[32m+[m[41m            [m
[32m+[m[32m            # å…³é”®è°ƒè¯•æ­¥éª¤ï¼šå°è¯•è§£æžJSONï¼Œå¦‚æžœå¤±è´¥ï¼Œåˆ™è®°å½•åŽŸå§‹å“åº”æ–‡æœ¬[m
[32m+[m[32m            try:[m
[32m+[m[32m                result = response.json()[m
[32m+[m[32m            except json.JSONDecodeError:[m
[32m+[m[32m                logger.error(f"APIå“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSONã€‚çŠ¶æ€ç : {response.status_code}, å“åº”æ–‡æœ¬: {response.text}")[m
[32m+[m[32m                return None, f"API response was not valid JSON. Raw text: {response.text}"[m
[32m+[m
[32m+[m[32m            if not result.get("data") or not result["data"][0].get("b64_json"):[m
[32m+[m[32m                error_msg = result.get("error", {}).get("message", "API did not return image data.")[m
[32m+[m[32m                raise ValueError(error_msg)[m
[32m+[m
[32m+[m[32m            # 4. è§£ç è¿”å›žçš„Base64æ•°æ®[m
[32m+[m[32m            output_image_base64 = result["data"][0]["b64_json"][m
[32m+[m[32m            output_image_bytes = base64.b64decode(output_image_base64)[m
[32m+[m[41m            [m
[32m+[m[32m            logger.info("Image edit data successfully received from gpt-image-1 API.")[m
[32m+[m[32m            return output_image_bytes, None[m
[32m+[m
[32m+[m[32m        except httpx.HTTPStatusError as e:[m
[32m+[m[32m            error_details = e.response.text[m
[32m+[m[32m            logger.error(f"Error calling gpt-image-1 edit API (HTTP {e.response.status_code}): {error_details}")[m
[32m+[m[32m            return None, f"HTTP {e.response.status_code} - {error_details}"[m
[32m+[m[32m        except Exception as e:[m
[32m+[m[32m            logger.error(f"Error processing gpt-image-1 edit response: {e}")[m
[32m+[m[32m            return None, str(e)[m
[32m+[m
[32m+[m[32m    async def close(self):[m
[32m+[m[32m        """å…³é—­ httpx å®¢æˆ·ç«¯ã€‚"""[m
[32m+[m[32m        if self.client:[m
[32m+[m[32m            await self.client.aclose()[m
[32m+[m[32m            logger.info("GptImage1EditorProvider (httpx) client closed.")[m
[1mdiff --git a/api/factory.py b/api/factory.py[m
[1mnew file mode 100644[m
[1mindex 0000000..97f8756[m
[1m--- /dev/null[m
[1m+++ b/api/factory.py[m
[36m@@ -0,0 +1,172 @@[m
[32m+[m[32m"""[m
[32m+[m[32mAPIå®¢æˆ·ç«¯å·¥åŽ‚[m
[32m+[m
[32m+[m[32mæ ¹æ®é…ç½®åŠ¨æ€åˆ›å»ºå¹¶è¿”å›žç›¸åº”çš„APIå®¢æˆ·ç«¯å®žä¾‹ã€‚[m
[32m+[m[32m"""[m
[32m+[m[32mfrom typing import Type[m
[32m+[m
[32m+[m[32mfrom .base import BaseLlmProvider, BaseImageProvider, BaseAuditProvider, BaseImageEditorProvider[m
[32m+[m[32mfrom .llm.doubao15thinkpro import Doubao15ThinkproProvider[m
[32m+[m[32mfrom .llm.openai import OpenAILLMProvider[m
[32m+[m[32mfrom .llm.tuzi import TuziProvider[m
[32m+[m[32mfrom .llm.gemini_2_5_pro import Gemini25ProProvider[m
[32m+[m[32mfrom .vision.doubao_seed_vision import DoubaoSeedVisionProvider[m
[32m+[m[32mfrom .vision.gemini_2_5_pro import Gemini25ProVisionProvider[m
[32m+[m[32mfrom .image.seedream import SeedreamProvider[m
[32m+[m[32mfrom .image.gpt_image_1 import GptImage1Provider[m
[32m+[m[32mfrom .edit.gpt_image_1 import GptImage1EditorProvider[m
[32m+[m
[32m+[m[32mfrom config import settings[m
[32m+[m[32mfrom utils.logger import logger[m
[32m+[m
[32m+[m[32mclass ApiClientFactory:[m
[32m+[m[32m    """[m
[32m+[m[32m    ä¸€ä¸ªæ ¹æ®é…ç½®åˆ›å»ºAPIå®¢æˆ·ç«¯çš„å·¥åŽ‚ç±»ã€‚[m
[32m+[m[32m    """[m
[32m+[m[41m    [m
[32m+[m[32m    # æ³¨å†Œè¡¨ï¼šå°†æä¾›å•†åç§°æ˜ å°„åˆ°å…¶å®žçŽ°ç±»[m
[32m+[m[32m    _llm_providers: dict[str, Type[BaseLlmProvider]] = {[m
[32m+[m[32m        "doubao15thinkpro": Doubao15ThinkproProvider,[m
[32m+[m[32m        "openai": OpenAILLMProvider,[m
[32m+[m[32m        "tuzi": TuziProvider,[m
[32m+[m[32m        "gemini_2_5_pro": Gemini25ProProvider,[m
[32m+[m[32m    }[m
[32m+[m[32m    _image_providers: dict[str, Type[BaseImageProvider]] = {[m
[32m+[m[32m        "seedream": SeedreamProvider,[m
[32m+[m[32m        "gpt_image_1": GptImage1Provider,[m
[32m+[m[32m    }[m
[32m+[m[32m    _vision_providers: dict[str, Type[BaseAuditProvider]] = {[m
[32m+[m[32m        "doubao_seed_1_6_vision": DoubaoSeedVisionProvider,[m
[32m+[m[32m        "gemini_2_5_pro": Gemini25ProVisionProvider,[m
[32m+[m[32m    }[m
[32m+[m[32m    _image_editor_providers: dict[str, Type[BaseImageEditorProvider]] = {[m
[32m+[m[32m        "gpt_image_1": GptImage1EditorProvider,[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    @staticmethod[m
[32m+[m[32m    def create_llm_client(provider_name: str) -> BaseLlmProvider | None:[m
[32m+[m[32m        """[m
[32m+[m[32m        æ ¹æ®æŒ‡å®šçš„æä¾›å•†åç§°åˆ›å»ºå¹¶è¿”å›žä¸€ä¸ªLLM APIå®¢æˆ·ç«¯å®žä¾‹ã€‚[m
[32m+[m
[32m+[m[32m        :param provider_name: è¦åˆ›å»ºçš„æä¾›å•†åç§° (ä¾‹å¦‚, 'tuzi', 'ark')ã€‚[m
[32m+[m[32m        :return: ä¸€ä¸ªéµå¾ª BaseLlmProvider æŽ¥å£çš„å®¢æˆ·ç«¯å®žä¾‹ï¼Œå¦‚æžœé…ç½®æ— æ•ˆåˆ™è¿”å›žNoneã€‚[m
[32m+[m[32m        """[m
[32m+[m[32m        logger.info(f"è¯·æ±‚åˆ›å»ºLLMå®¢æˆ·ç«¯ï¼Œæä¾›å•†: {provider_name}")[m
[32m+[m
[32m+[m[32m        provider_class = ApiClientFactory._llm_providers.get(provider_name)[m
[32m+[m[32m        if not provider_class:[m
[32m+[m[32m            logger.error(f"æœªçŸ¥çš„LLMæä¾›å•†: {provider_name}")[m
[32m+[m[32m            raise ValueError(f"æœªçŸ¥çš„LLMæä¾›å•†: {provider_name}")[m
[32m+[m
[32m+[m[32m        try:[m
[32m+[m[32m            provider_config = settings.LLM_API_CONFIGS.get(provider_name, {})[m
[32m+[m[32m            return provider_class(**provider_config)[m
[32m+[m[32m        except (ValueError, TypeError) as e:[m
[32m+[m[32m            logger.error(f"åˆ›å»ºLLMå®¢æˆ·ç«¯ '{provider_name}' æ—¶å‡ºé”™: {e}")[m
[32m+[m[32m            return None[m
[32m+[m
[32m+[m[32m    @staticmethod[m
[32m+[m[32m    def create_image_client() -> BaseImageProvider | None:[m
[32m+[m[32m        """[m
[32m+[m[32m        æ ¹æ®å…¨å±€é…ç½®åˆ›å»ºå¹¶è¿”å›žä¸€ä¸ªå›¾ç‰‡ç”ŸæˆAPIå®¢æˆ·ç«¯å®žä¾‹ã€‚[m
[32m+[m
[32m+[m[32m        :return: ä¸€ä¸ªéµå¾ª BaseImageProvider æŽ¥å£çš„å®¢æˆ·ç«¯å®žä¾‹ï¼Œå¦‚æžœé…ç½®æ— æ•ˆåˆ™è¿”å›žNoneã€‚[m
[32m+[m[32m        """[m
[32m+[m[32m        provider_name = settings.IMAGE_API_PROVIDER[m
[32m+[m[32m        logger.info(f"æ ¹æ®é…ç½®åˆ›å»ºå›¾ç‰‡ç”Ÿæˆå®¢æˆ·ç«¯ï¼Œæä¾›å•†: {provider_name}")[m
[32m+[m
[32m+[m[32m        provider_class = ApiClientFactory._image_providers.get(provider_name)[m
[32m+[m[32m        if not provider_class:[m
[32m+[m[32m            logger.error(f"æœªçŸ¥çš„å›¾ç‰‡ç”Ÿæˆæä¾›å•†: {provider_name}")[m
[32m+[m[32m            raise ValueError(f"æœªçŸ¥çš„å›¾ç‰‡ç”Ÿæˆæä¾›å•†: {provider_name}")[m
[32m+[m
[32m+[m[32m        try:[m
[32m+[m[32m            provider_config = settings.IMAGE_API_CONFIGS.get(provider_name, {})[m
[32m+[m[32m            return provider_class(**provider_config)[m
[32m+[m[32m        except (ValueError, TypeError) as e:[m
[32m+[m[32m            logger.error(f"åˆ›å»ºå›¾ç‰‡ç”Ÿæˆå®¢æˆ·ç«¯ '{provider_name}' æ—¶å‡ºé”™: {e}")[m
[32m+[m[32m            return None[m
[32m+[m
[32m+[m[32m    @staticmethod[m
[32m+[m[32m    def create_vision_client() -> BaseAuditProvider | None:[m
[32m+[m[32m        """[m
[32m+[m[32m        æ ¹æ®å…¨å±€é…ç½®åˆ›å»ºå¹¶è¿”å›žä¸€ä¸ªè§†è§‰ç†è§£APIå®¢æˆ·ç«¯å®žä¾‹ã€‚[m
[32m+[m
[32m+[m[32m        :return: ä¸€ä¸ªéµå¾ª BaseAuditProvider æŽ¥å£çš„å®¢æˆ·ç«¯å®žä¾‹ï¼Œå¦‚æžœé…ç½®æ— æ•ˆåˆ™è¿”å›žNoneã€‚[m
[32m+[m[32m        """[m
[32m+[m[32m        provider_name = settings.VISION_API_PROVIDER[m
[32m+[m[32m        logger.info(f"æ ¹æ®é…ç½®åˆ›å»ºè§†è§‰ç†è§£å®¢æˆ·ç«¯ï¼Œæä¾›å•†: {provider_name}")[m
[32m+[m
[32m+[m[32m        provider_class = ApiClientFactory._vision_providers.get(provider_name)[m
[32m+[m[32m        if not provider_class:[m
[32m+[m[32m            logger.error(f"æœªçŸ¥çš„è§†è§‰ç†è§£æä¾›å•†: {provider_name}")[m
[32m+[m[32m            raise ValueError(f"æœªçŸ¥çš„è§†è§‰ç†è§£æä¾›å•†: {provider_name}")[m
[32m+[m
[32m+[m[32m        try:[m
[32m+[m[32m            provider_config = settings.VISION_API_CONFIGS.get(provider_name, {})[m
[32m+[m[32m            return provider_class(**provider_config)[m
[32m+[m[32m        except (ValueError, TypeError) as e:[m
[32m+[m[32m            logger.error(f"åˆ›å»ºè§†è§‰ç†è§£å®¢æˆ·ç«¯ '{provider_name}' æ—¶å‡ºé”™: {e}")[m
[32m+[m[32m            return None[m
[32m+[m
[32m+[m[32m    @staticmethod[m
[32m+[m[32m    def create_image_editor_client() -> BaseImageEditorProvider | None:[m
[32m+[m[32m        """[m
[32m+[m[32m        æ ¹æ®å…¨å±€é…ç½®åˆ›å»ºå¹¶è¿”å›žä¸€ä¸ªå›¾ç‰‡ç¼–è¾‘APIå®¢æˆ·ç«¯å®žä¾‹ã€‚[m
[32m+[m[32m        """[m
[32m+[m[32m        provider_name = settings.IMAGE_EDITOR_API_PROVIDER[m
[32m+[m[32m        logger.info(f"æ ¹æ®é…ç½®åˆ›å»ºå›¾ç‰‡ç¼–è¾‘å®¢æˆ·ç«¯ï¼Œæä¾›å•†: {provider_name}")[m
[32m+[m
[32m+[m[32m        provider_class = ApiClientFactory._image_editor_providers.get(provider_name)[m
[32m+[m[32m        if not provider_class:[m
[32m+[m[32m            logger.error(f"æœªçŸ¥çš„å›¾ç‰‡ç¼–è¾‘æä¾›å•†: {provider_name}")[m
[32m+[m[32m            raise ValueError(f"æœªçŸ¥çš„å›¾ç‰‡ç¼–è¾‘æä¾›å•†: {provider_name}")[m
[32m+[m
[32m+[m[32m        try:[m
[32m+[m[32m            provider_config = settings.IMAGE_EDITOR_API_CONFIGS.get(provider_name, {})[m
[32m+[m[32m            return provider_class(**provider_config)[m
[32m+[m[32m        except (ValueError, TypeError) as e:[m
[32m+[m[32m            logger.error(f"åˆ›å»ºå›¾ç‰‡ç¼–è¾‘å®¢æˆ·ç«¯ '{provider_name}' æ—¶å‡ºé”™: {e}")[m
[32m+[m[32m            return None[m
[32m+[m
[32m+[m
[32m+[m[32mdef get_llm_api(provider_name: str | None = None) -> BaseLlmProvider | None:[m
[32m+[m[32m    """[m
[32m+[m[32m    ä¾¿æ·å‡½æ•°ï¼šèŽ·å–LLM APIå®¢æˆ·ç«¯å®žä¾‹ã€‚[m
[32m+[m[41m    [m
[32m+[m[32m    Args:[m
[32m+[m[32m        provider_name (str, optional): è¦ä½¿ç”¨çš„LLMæä¾›å•†åç§°ã€‚å¦‚æžœä¸ºNoneï¼Œåˆ™ä½¿ç”¨é»˜è®¤è®¾ç½®ã€‚[m
[32m+[m[41m    [m
[32m+[m[32m    Returns:[m
[32m+[m[32m        BaseLlmProvider | None: LLM APIå®¢æˆ·ç«¯å®žä¾‹ï¼Œå¦‚æžœåˆ›å»ºå¤±è´¥åˆ™è¿”å›žNoneã€‚[m
[32m+[m[32m    """[m
[32m+[m[32m    if provider_name is None:[m
[32m+[m[32m        provider_name = settings.LLM_ROLES.get("default")[m
[32m+[m[41m        [m
[32m+[m[32m    return ApiClientFactory.create_llm_client(provider_name)[m
[32m+[m
[32m+[m
[32m+[m[32mdef get_image_api() -> BaseImageProvider | None:[m
[32m+[m[32m    """[m
[32m+[m[32m    ä¾¿æ·å‡½æ•°ï¼šèŽ·å–å›¾ç‰‡ç”ŸæˆAPIå®¢æˆ·ç«¯å®žä¾‹ã€‚[m
[32m+[m[41m    [m
[32m+[m[32m    Returns:[m
[32m+[m[32m        BaseImageProvider | None: å›¾ç‰‡ç”ŸæˆAPIå®¢æˆ·ç«¯å®žä¾‹ï¼Œå¦‚æžœåˆ›å»ºå¤±è´¥åˆ™è¿”å›žNoneã€‚[m
[32m+[m[32m    """[m
[32m+[m[32m    return ApiClientFactory.create_image_client()[m
[32m+[m
[32m+[m[32mdef get_vision_api() -> BaseAuditProvider | None:[m
[32m+[m[32m    """[m
[32m+[m[32m    ä¾¿æ·å‡½æ•°ï¼šèŽ·å–è§†è§‰ç†è§£APIå®¢æˆ·ç«¯å®žä¾‹ã€‚[m
[32m+[m[41m    [m
[32m+[m[32m    Returns:[m
[32m+[m[32m        BaseAuditProvider | None: è§†è§‰ç†è§£APIå®¢æˆ·ç«¯å®žä¾‹ï¼Œå¦‚æžœåˆ›å»ºå¤±è´¥åˆ™è¿”å›žNoneã€‚[m
[32m+[m[32m    """[m
[32m+[m[32m    return ApiClientFactory.create_vision_client()[m
[32m+[m
[32m+[m
[32m+[m[32mdef get_image_editor_api() -> BaseImageEditorProvider | None:[m
[32m+[m[32m    """[m
